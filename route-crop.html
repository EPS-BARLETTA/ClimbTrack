<!doctype html><html lang="fr"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ClimbTrack ‚Äî Recadrer la photo</title><link rel="stylesheet" href="style.css"></head>
<body><div class="main-wrap"><div class="container">
  <div class="headerbar"><div class="logo">üñºÔ∏è <span class="highlight">Recadrer la photo</span></div>
    <div class="right"><a class="btn green big" href="menu.html">üè† Menu</a></div></div>
  <div class="card">
    <h2>√âtape 2 ‚Äî Cadre ta zone (zoom + d√©placement + rotation)</h2>
    <div class="crop-wrap">
      <div class="crop-frame" id="frame">
        <img id="img" class="crop-img" alt="photo" />
        <div class="overlay"></div>
      </div>
      <div class="ctrls">
        <label>Zoom <input id="zoom" type="range" min="50" max="300" value="100" class="slider"></label>
        <button class="btn amber" id="fit">Ajuster</button>
        <button class="btn blue" id="rot">Rotation 90¬∞</button>
        <button class="btn green" id="go">Recadrer & dessiner</button>
      </div>
      <p class="note center">Astuce iPad : pincer pour zoomer, glisser pour d√©placer l‚Äôimage.</p>
    </div>
  </div>
</div></div>
<footer><div class="container"><div class="footer-inner"></div></div></footer>

<script type="module">
import {getRouteImage, setRouteImage, renderFooter} from './app.js';
renderFooter();
const src = getRouteImage(); if(!src){ alert('Pas de photo. Reviens √† la capture.'); location.href='route-capture.html'; }
const img = document.getElementById('img'); const frame=document.getElementById('frame');
const zoom=document.getElementById('zoom'); const fitBtn=document.getElementById('fit'); const rotBtn=document.getElementById('rot'); const goBtn=document.getElementById('go');

let scale=1, angle=0, dx=0, dy=0, baseDist=0, baseScale=1, dragging=false, lastX=0, lastY=0;

img.onload=()=>{ fit(); };
img.src=src;

function frameSize(){ const r=frame.getBoundingClientRect(); return {w:r.width, h:r.height}; }
function apply(){ img.style.transform=`translate(${dx}px,${dy}px) rotate(${angle}deg) scale(${scale}) translate(-50%,-50%)`; }
function fit(){ const {w,h}=frameSize(); const iw=img.naturalWidth, ih=img.naturalHeight; const ar=iw/ih; let fw=w, fh=w/ar; if(fh<h){ fh=h; fw=fh*ar; }
  const base = fw/iw; scale = base*(zoom.value/100); dx=0; dy=0; apply(); }

zoom.addEventListener('input', ()=>{ const {w,h}=frameSize(); const iw=img.naturalWidth, ih=img.naturalHeight; const ar=iw/ih; let fw=w, fh=w/ar; if(fh<h){ fh=h; fw=fh*ar; } const base = fw/iw; scale = base*(zoom.value/100); apply(); });
fitBtn.onclick=fit;
rotBtn.onclick=()=>{ angle=(angle+90)%360; apply(); };

// Drag/pan + pinch
function startDrag(x,y){ dragging=true; lastX=x; lastY=y; }
function moveDrag(x,y){ if(!dragging) return; dx += (x-lastX); dy += (y-lastY); lastX=x; lastY=y; apply(); }
function endDrag(){ dragging=false; }
frame.addEventListener('mousedown', e=>startDrag(e.clientX,e.clientY));
window.addEventListener('mousemove', e=>moveDrag(e.clientX,e.clientY));
window.addEventListener('mouseup', endDrag);
frame.addEventListener('touchstart', (e)=>{
  if(e.touches.length===1){ startDrag(e.touches[0].clientX, e.touches[0].clientY); baseDist=0; }
  else if(e.touches.length===2){ dragging=false; baseDist=dist(e.touches[0], e.touches[1]); baseScale=scale; }
},{passive:false});
frame.addEventListener('touchmove', (e)=>{
  if(e.touches.length===1 && dragging){ moveDrag(e.touches[0].clientX, e.touches[0].clientY); }
  else if(e.touches.length===2){ const d=dist(e.touches[0], e.touches[1]); if(!baseDist) baseDist=d; const factor=d/baseDist; scale = baseScale*factor; apply(); }
},{passive:false});
window.addEventListener('touchend', endDrag);
function dist(a,b){ const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; return Math.hypot(dx,dy); }

goBtn.onclick=()=>{
  const {w,h}=frameSize(); const dpr=window.devicePixelRatio||1; const c=document.createElement('canvas'); c.width=Math.round(w*dpr); c.height=Math.round(h*dpr);
  const ctx=c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.fillStyle='#000'; ctx.fillRect(0,0,w,h);
  ctx.save();
  ctx.translate(w/2 + dx, h/2 + dy);
  ctx.rotate(angle*Math.PI/180);
  ctx.scale(scale, scale);
  const iw=img.naturalWidth, ih=img.naturalHeight;
  ctx.drawImage(img, -iw/2, -ih/2);
  ctx.restore();
  const out=c.toDataURL('image/png');
  setRouteImage(out);
  location.href='route-draw.html';
};
</script>
</body></html>
