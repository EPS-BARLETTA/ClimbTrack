<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ClimbTrack â€” DifficultÃ©</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="main-wrap">
  <div class="container">
    <div class="headerbar">
      <div class="logo">ğŸ§— <span class="highlight">DifficultÃ©</span></div>
      <div class="right">
        <a class="btn green big" href="menu.html">ğŸ  Menu</a>
        <a class="btn blue big" href="aide.html">â“ Aide</a>
      </div>
    </div>

    <div class="card">
      <h2>Saisie (cotation / relais / style)</h2>
      <p class="lead" id="idline"></p>

      <label>Cotation<input id="d_cotation" placeholder="Ex. 5c, 6a+"></label>
      <label>Relais atteint (X)<input id="d_relais" type="number" min="0" max="40" placeholder="Ex. 5"></label>
      <label>Style
        <select id="d_style">
          <option value="moulinette">Moulinette</option>
          <option value="en_tete">En tÃªte</option>
          <option value="mouli_tete">Mouli-tÃªte</option>
        </select>
      </label>

      <label>RÃ©sultat
        <select id="d_resultat">
          <option value="e1">Voie enchaÃ®nÃ©e (1er essai)</option>
          <option value="e2">EnchaÃ®nÃ©e en 2e essai</option>
          <option value="ne">Pas enchaÃ®nÃ©e</option>
        </select>
      </label>

      <div id="motifs" style="display:none;">
        <div class="row row-3">
          <div class="card" id="m_deg" style="text-align:left;">
            <label>DÃ©gaine (numÃ©ro)<input id="d_degx" type="number" min="0" max="40" placeholder="Ex. 4"></label>
          </div>
          <div class="card" id="m_mc" style="text-align:left;">
            <label>Prises en plus (multi-couleur)<input id="d_nbprise" type="number" min="0" max="20" placeholder="Ex. 2"></label>
          </div>
          <div class="card" id="m_td" style="text-align:left;">
            <label><input type="checkbox" id="d_td"> Trop difficile</label>
          </div>
        </div>
        <p class="small">Codes gÃ©nÃ©rÃ©s : <strong>NEDx</strong> (dÃ©gaine x), <strong>MCx</strong> (prises en plus), <strong>TD</strong> (trop difficile).</p>
      </div>

      <div class="actions">
        <button class="btn blue big" id="btn_add">â• Ajouter</button>
        <button class="btn red big" id="btn_clear">â™»ï¸ Vider</button>
      </div>

      <table class="table" id="d_table">
        <thead>
          <tr><th>#</th><th>Cotation</th><th>Relais</th><th>Style</th><th>RÃ©sultat</th><th>DÃ©tails</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="actions">
        <button class="btn green big" id="btn_save">ğŸ’¾ Enregistrer sÃ©ance</button>
        <button class="btn green big" id="btn_qr">ğŸ“· QR code DifficultÃ©</button>
        <a class="btn" href="seance.html">â¡ï¸ QR de sÃ©ance</a>
      </div>

      <div id="qr-section" style="display:none;margin-top:16px;">
        <h3>ğŸ“· QR code prÃªt</h3>
        <div class="qr-wrap">
          <div class="qr-box" id="qrd"></div>
          <pre class="pre" id="jsond"></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container"><div class="footer-inner"></div></div>
</footer>

<div id="autosave-toast" style="
    position:fixed; left:50%; bottom:16px; transform:translate(-50%,12px);
    background:#16a34a; color:#fff; padding:10px 14px; border-radius:12px;
    font-weight:600; font-size:.95rem; box-shadow:0 6px 18px rgba(0,0,0,.2);
    opacity:0; transition:opacity .25s ease, transform .25s ease; z-index:9999;
">SÃ©ance enregistrÃ©e âœ…</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script type="module">
import {getIdentite, ensureIdentite, renderFooter, loadSeance, saveSeance, makeQR} from './app.js';

renderFooter();
ensureIdentite();

const id = getIdentite();
document.getElementById('idline').innerHTML = `Ã‰lÃ¨ve : <strong>${id.prenom} ${id.nom}</strong> â€” <span class='badge'>Classe : ${id.classe}</span>`;

function styleCode(sty){ if(sty==='moulinette') return 'M'; if(sty==='en_tete') return 'T'; if(sty==='mouli_tete') return 'MT'; return ''; }
function motifCodeNE({degx, nbprise, td}){
  const parts=[]; 
  if(degx && degx>0) parts.push('NED'+degx); 
  if(nbprise && nbprise>0) parts.push('MC'+nbprise); 
  if(td) parts.push('TD'); 
  return parts.join(' ');
}

const tbody=document.querySelector('#d_table tbody'); 
const list=[];

const dres=document.getElementById('d_resultat'), motifs=document.getElementById('motifs');
dres.addEventListener('change', ()=>{ motifs.style.display = (dres.value==='ne') ? 'block' : 'none'; });

function showToast(msg='SÃ©ance enregistrÃ©e âœ…'){
  const t = document.getElementById('autosave-toast');
  t.textContent = msg;
  t.style.opacity = '1';
  t.style.transform = 'translate(-50%, 0)';
  clearTimeout(t._hide);
  t._hide = setTimeout(()=>{
    t.style.opacity = '0';
    t.style.transform = 'translate(-50%, 12px)';
  }, 1500);
}

function render(){
  tbody.innerHTML='';
  list.forEach((it,i)=>{
    let resTxt = (it.res==='e1')?'EnchaÃ®nÃ©e (1er)':(it.res==='e2'?'EnchaÃ®nÃ©e (2e)':'Non enchaÃ®nÃ©e');
    let details = '';
    if(it.res==='ne'){
      const parts=[]; 
      if(it.degx>0) parts.push('DÃ©gaine '+it.degx); 
      if(it.nbprise>0) parts.push('MC '+it.nbprise); 
      if(it.td) parts.push('TD');
      details = parts.join(' â€¢ ');
    }
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${it.cotation}</td><td>${it.relais}</td><td>${it.style}</td><td>${resTxt}</td><td>${details}</td><td><button class="btn red" data-i="${i}">Supprimer</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-i]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      list.splice(+e.currentTarget.dataset.i,1);
      render();
      debouncedAutoSave();
    });
  });
}

function persistDifficulte(silent=true){
  if (!list.length) return;
  const s = loadSeance();
  s.difficulte = list.slice();
  saveSeance(s);
  showToast();
  if (!silent) alert('DifficultÃ© enregistrÃ©e âœ…');
}

function debounce(fn, delay){
  let t;
  return (...args)=>{
    clearTimeout(t);
    t=setTimeout(()=>fn(...args), delay);
  };
}
const debouncedAutoSave = debounce(()=>persistDifficulte(true), 800);

document.getElementById('btn_add').onclick=()=>{
  const cot=d_cotation.value.trim().toUpperCase();
  const rel=parseInt(d_relais.value||'0',10);
  const sty=d_style.value;
  const res=d_resultat.value; // e1,e2,ne
  if(!cot){ alert('Saisir une cotation'); return; }
  const it={cotation:cot, relais:rel, style:sty, res:res};
  if(res==='ne'){ 
    it.degx=parseInt(d_degx.value|| '0',10); 
    it.nbprise=parseInt(d_nbprise.value|| '0',10); 
    it.td=document.getElementById('d_td').checked; 
  }
  list.push(it); 
  render();
  debouncedAutoSave();
};

document.getElementById('btn_clear').onclick=()=>{ 
  list.length=0; 
  render(); 
};

document.getElementById('btn_save').onclick=()=>{ 
  persistDifficulte(false);
};

document.getElementById('btn_qr').onclick=()=>{
  if(!list.length){ alert('Ajoute une rÃ©alisation'); return; }
  const obj={ nom:id.nom, prenom:id.prenom, classe:id.classe };
  list.forEach((d,idx)=>{
    const sc=styleCode(d.style);
    let code=''; 
    if(d.res==='e1') code='E'; 
    else if(d.res==='e2') code='E2'; 
    else { 
      const ne = motifCodeNE({degx:d.degx, nbprise:d.nbprise, td:d.td}); 
      code = 'NE' + (ne?(' '+ne):''); 
    }
    obj['difficulte_'+(idx+1)] = `${sc} R${d.relais} ${d.cotation} ${code}`;
  });
  const txt=makeQR('qrd', obj); 
  jsond.textContent=txt; 
  document.getElementById('qr-section').style.display='block';
};

document.addEventListener('visibilitychange', ()=>{ if (document.hidden) persistDifficulte(true); });
window.addEventListener('beforeunload', ()=>{ persistDifficulte(true); });
setInterval(()=>persistDifficulte(true), 30000);

render();
</script>
</body>
</html>
