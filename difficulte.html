<!doctype html><html lang="fr"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ClimbTrack — Difficulté</title><link rel="stylesheet" href="style.css"></head>
<body><div class="main-wrap"><div class="container">
  <div class="headerbar"><div class="logo">🧗 <span class="highlight">Difficulté</span></div>
    <div class="right"><a class="btn green big" href="menu.html">🏠 Menu</a><a class="btn blue big" href="aide.html">❓ Aide</a></div></div>
  <div class="card"><h2>Saisie (cotation / relais / style)</h2><p class="lead" id="idline"></p>
    <label>Cotation<input id="d_cotation" placeholder="Ex. 5c, 6a+"></label>
    <label>Relais atteint (X)<input id="d_relais" type="number" min="0" max="40" placeholder="Ex. 5"></label>
    <label>Style<select id="d_style"><option value="moulinette">Moulinette</option><option value="en_tete">En tête</option><option value="mouli_tete">Mouli-tête</option></select></label>
    <label>Résultat<select id="d_resultat"><option value="reussie">Réussie</option><option value="non_terminee">Essayée mais non terminée</option></select></label>
    <div id="motifs" style="display:none;">
      <label>Motif<select id="d_motif"><option value="chute_degaine">Chute à la dégaine (préciser X)</option><option value="autre_prise">Autre prise (préciser nb)</option><option value="fatigue">Fatigue</option><option value="peur">Peur</option><option value="technique">Difficulté technique</option></select></label>
      <div id="motif_deg" style="display:none;"><label>Dégaine X<input id="d_degx" type="number" min="0" max="40" placeholder="Ex. 5"></label></div>
      <div id="motif_nb" style="display:none;"><label>Nb. de prises <input id="d_nbprise" type="number" min="1" max="20" placeholder="Ex. 2"></label></div>
    </div>
    <div class="actions"><button class="btn blue big" id="btn_add">➕ Ajouter</button><button class="btn red big" id="btn_clear">♻️ Vider</button></div>
    <table class="table" id="d_table"><thead><tr><th>#</th><th>Cotation</th><th>Relais</th><th>Style</th><th>Résultat</th><th>Motif</th><th>Action</th></tr></thead><tbody></tbody></table>
    <div class="actions"><button class="btn green big" id="btn_save">💾 Enregistrer séance</button><button class="btn green big" id="btn_qr">📷 QR Difficulté (JSON)</button><a class="btn" href="seance.html">➡️ QR de séance</a></div>
    <div id="qr-section" style="display:none;margin-top:16px;"><h3>📷 QR prêt (JSON)</h3><div class="qr-wrap"><div class="qr-box" id="qrd"></div><pre class="pre" id="jsond"></pre></div></div>
  </div></div>
  <footer><div class="container"><div class="footer-inner"></div></div></footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script type="module">
import {getIdentite, ensureIdentite, renderFooter, loadSeance, saveSeance, makeQR} from './app.js';
renderFooter(); ensureIdentite();
const id = getIdentite();
document.getElementById('idline').innerHTML = `Élève : <strong>${id.Prenom} ${id.Nom}</strong> — <span class='badge'>Classe : ${id.Classe}</span>`;

const tbody=document.querySelector('#d_table tbody'); const list=[];
const dres=document.getElementById('d_resultat'), motifs=document.getElementById('motifs'), motifSel=document.getElementById('d_motif');
const motif_deg=document.getElementById('motif_deg'), motif_nb=document.getElementById('motif_nb');
function updateMotifFields(){ const m=motifSel.value; motif_deg.style.display=(m==='chute_degaine')?'block':'none'; motif_nb.style.display=(m==='autre_prise')?'block':'none'; }
dres.addEventListener('change', ()=>{ motifs.style.display = (dres.value==='non_terminee') ? 'block' : 'none'; updateMotifFields(); });
motifSel.addEventListener('change', updateMotifFields);
function render(){ tbody.innerHTML=''; list.forEach((it,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${it.cotation}</td><td>${it.relais}</td><td>${it.style}</td><td>${it.resultat}</td><td>${it.motif||''}</td><td><button class="btn red" data-i="${i}">Supprimer</button></td>`; tbody.appendChild(tr); });
  tbody.querySelectorAll('button[data-i]').forEach(btn=>btn.addEventListener('click', e=>{ list.splice(+e.currentTarget.dataset.i,1); render(); })); }
function motifToTxt(m,degx,nbp){ if(m==='chute_degaine') return 'degX'+(degx||'?'); if(m==='autre_prise') return 'autre_prise:n'+(nbp||'?'); if(m==='fatigue') return 'fatigue'; if(m==='peur') return 'peur'; if(m==='technique') return 'technique'; return ''; }
document.getElementById('btn_add').onclick=()=>{
  const cot=d_cotation.value.trim(); const rel=parseInt(d_relais.value||'0',10); const sty=d_style.value; const res=d_resultat.value;
  if(!cot){ alert('Saisir une cotation'); return; }
  const it={cotation:cot, relais:rel, style:sty, resultat:(res==='reussie'?'OK':'NT'), motif:(res==='non_terminee'?motifToTxt(motifSel.value, parseInt(d_degx.value||'0',10), parseInt(d_nbprise.value||'0',10)):'')};
  list.push(it); render();
};
document.getElementById('btn_clear').onclick=()=>{ list.length=0; render(); };
document.getElementById('btn_save').onclick=()=>{ const s=loadSeance(); s.difficulte=list.slice(); saveSeance(s); alert('Difficulté enregistrée ✅'); };
document.getElementById('btn_qr').onclick=()=>{
  if(!list.length){ alert('Ajoute une réalisation'); return; }
  const obj={Nom:id.Nom, Prenom:id.Prenom, Classe:id.Classe, Difficulte:list};
  const txt=makeQR('qrd', obj); jsond.textContent=txt; document.getElementById('qr-section').style.display='block';
};
</script></body></html>
