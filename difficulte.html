<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ClimbTrack ‚Äî Difficult√©</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="main-wrap">
  <div class="container">
    <div class="headerbar">
      <div class="logo">üßó <span class="highlight">Difficult√©</span></div>
      <div class="right">
        <a class="btn green" href="menu.html">üè† Menu</a>
        <a class="btn violet" href="aide.html">‚ùì Aide</a>
        <a class="btn amber" href="securite.html">ü¶∫ S√©curit√©</a>
      </div>
    </div>
    <div class="card">
      <h2>Voie & Cotation</h2>
      <p class="lead" id="idline"></p>

      <div class="row row-2">
        <div class="card">
          <label>Voie (nom/num√©ro)<input id="d_voie" placeholder="Ex. n¬∞7 ou 'Ar√™te Ouest'"></label>
          <label>Cotation<input id="d_cotation" placeholder="Ex. 5c, 6a+"></label>
          <label>Relais atteint (X)<input id="d_relais" type="number" min="0" max="30" placeholder="Ex. 5"></label>
          <label>R√©sultat
            <select id="d_resultat">
              <option value="reussie">R√©ussie</option>
              <option value="non_terminee">Essay√©e mais non termin√©e</option>
            </select>
          </label>
          <div id="motifs" style="display:none;">
            <label>Motif principal
              <select id="d_motif">
                <option value="chute_degaine">Chute √† la d√©gaine (pr√©ciser X)</option>
                <option value="autre_prise">Utilisation d'une autre prise</option>
                <option value="fatigue">Fatigue</option>
                <option value="peur">Peur</option>
                <option value="technique">Difficult√© technique</option>
                <option value="autre">Autre (pr√©ciser)</option>
              </select>
            </label>
            <label>D√©tails (ex. d√©gaine 5, remarque‚Ä¶)<input id="d_details" placeholder="Ex. loup√© d√©gaine 5"></label>
          </div>
          <div class="actions">
            <button class="btn blue" id="btn-diff">üßæ G√©n√©rer le QR</button>
          </div>
        </div>

        <div class="card">
          <h3>Conseils</h3>
          <ul>
            <li>Note la <strong>cotation</strong> et le <strong>relais (X)</strong> atteints.</li>
            <li>Si non termin√©e, choisis un <strong>motif</strong> et ajoute un d√©tail (ex. ‚Äúd√©gaine 5‚Äù).</li>
            <li>Une saisie = un QR. Recommence pour une autre voie.</li>
          </ul>
        </div>
      </div>

      <div id="qr-section" style="display:none; margin-top:16px;">
        <h3>üì∑ QR pr√™t</h3>
        <div class="qr-wrap">
          <div class="qr-box" id="qrd"></div>
          <pre class="pre" id="jsond"></pre>
        </div>
      </div>
    </div>
  </div>
  <footer><div class="container"><div class="footer-inner"></div></div></footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script type="module">
  import {getIdentite, ensureIdentite, renderFooter, makeQR, nowISO} from './app.js';
  renderFooter(); ensureIdentite();
  const id = getIdentite();
  document.getElementById('idline').innerHTML = `√âl√®ve : <strong>${id.Prenom} ${id.Nom}</strong> ‚Äî <span class='badge'>Classe : ${id.Classe}</span>`;

  const dres = document.getElementById('d_resultat');
  const motifs = document.getElementById('motifs');
  dres.addEventListener('change', ()=>{
    motifs.style.display = (dres.value === 'non_terminee') ? 'block' : 'none';
  });

  document.getElementById('btn-diff').addEventListener('click', ()=>{
    const Voie = document.getElementById('d_voie').value.trim();
    const Cotation = document.getElementById('d_cotation').value.trim();
    const Relais = parseInt(document.getElementById('d_relais').value||'0',10);
    const Resultat = document.getElementById('d_resultat').value;
    const payload = {
      App:'ClimbTrack', Type:'difficulte',
      Nom:id.Nom, Prenom:id.Prenom, Classe:id.Classe,
      Voie, Cotation, Relais,
      Resultat,
      DateISO: nowISO()
    };
    if(Resultat==='non_terminee'){
      payload.Motif = document.getElementById('d_motif').value;
      payload.Details = document.getElementById('d_details').value.trim() || null;
    }
    const {json} = makeQR(document.getElementById('qrd'), payload);
    document.getElementById('jsond').textContent = json;
    document.getElementById('qr-section').style.display = 'block';
    window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
  });
</script>
</body>
</html>
