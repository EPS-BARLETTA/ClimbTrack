<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ClimbTrack — Difficulté</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="main-wrap">
  <div class="container">
    <div class="headerbar">
      <div class="logo">🧗 <span class="highlight">Difficulté</span></div>
      <div class="right">
        <a class="btn green" href="menu.html">🏠 Menu</a>
        <a class="btn violet" href="aide.html">❓ Aide</a>
        <a class="btn amber" href="securite.html">🦺 Sécurité</a>
      </div>
    </div>
    <div class="card">
      <h2>Saisie (cotation / relais / style)</h2>
      <p class="lead" id="idline"></p>

      <div class="row row-2">
        <div class="card">
          <label>Cotation<input id="d_cotation" placeholder="Ex. 5c, 6a+"></label>
          <label>Relais atteint (X)<input id="d_relais" type="number" min="0" max="40" placeholder="Ex. 5"></label>
          <label>Style
            <select id="d_style">
              <option value="moulinette">Moulinette</option>
              <option value="en_tete">En tête</option>
              <option value="mouli_tete">Mouli-tête</option>
            </select>
          </label>
          <label>Résultat
            <select id="d_resultat">
              <option value="reussie">Réussie</option>
              <option value="non_terminee">Essayée mais non terminée</option>
            </select>
          </label>
          <div id="motifs" style="display:none;">
            <label>Motif principal
              <select id="d_motif">
                <option value="chute_degaine">Chute à la dégaine (préciser X)</option>
                <option value="autre_prise">Autre prise</option>
                <option value="fatigue">Fatigue</option>
                <option value="peur">Peur</option>
                <option value="technique">Difficulté technique</option>
                <option value="autre">Autre (préciser)</option>
              </select>
            </label>
            <label>Détails (ex. dégaine 5, remarque…)<input id="d_details" placeholder="Ex. loupé dégaine 5"></label>
          </div>
          <div class="actions">
            <button class="btn blue" id="btn-add">➕ Ajouter à la séance</button>
            <button class="btn red" id="btn-clear">♻️ Vider la séance</button>
          </div>
        </div>

        <div class="card">
          <h3>Liste de séance</h3>
          <table class="table" id="d_table">
            <thead><tr><th>#</th><th>Cotation</th><th>Relais</th><th>Style</th><th>Résultat</th><th>Motif</th><th>Action</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="actions">
            <button class="btn green" id="btn-qr">📷 Générer le QR</button>
          </div>
        </div>
      </div>

      <div id="qr-section" style="display:none; margin-top:16px;">
        <h3>📷 QR prêt</h3>
        <div class="qr-wrap">
          <div class="qr-box" id="qrd"></div>
          <pre class="pre" id="jsond"></pre>
        </div>
      </div>
    </div>
  </div>
  <footer><div class="container"><div class="footer-inner"></div></div></footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script type="module">
  import {getIdentite, ensureIdentite, renderFooter, makeQR, nowISO} from './app.js';
  renderFooter(); ensureIdentite();
  const id = getIdentite();
  document.getElementById('idline').innerHTML = `Élève : <strong>${id.Prenom} ${id.Nom}</strong> — <span class='badge'>Classe : ${id.Classe}</span>`;

  const dres = document.getElementById('d_resultat');
  const motifs = document.getElementById('motifs');
  dres.addEventListener('change', ()=>{ motifs.style.display = (dres.value === 'non_terminee') ? 'block' : 'none'; });

  const list = [];
  const tbody = document.querySelector('#d_table tbody');

  function render(){
    tbody.innerHTML = "";
    list.forEach((it, idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${idx+1}</td>
        <td>${it.Cotation||''}</td>
        <td>${it.Relais??''}</td>
        <td>${it.Style}</td>
        <td>${it.Resultat}</td>
        <td>${(it.Motif||'')}${it.Details?(' - '+it.Details):''}</td>
        <td><button class="btn red" data-i="${idx}">Supprimer</button></td>`;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('button[data-i]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const i = parseInt(e.currentTarget.getAttribute('data-i'),10);
        list.splice(i,1); render();
      });
    });
  }

  document.getElementById('btn-add').onclick = ()=>{
    const Cotation = document.getElementById('d_cotation').value.trim();
    const Relais = parseInt(document.getElementById('d_relais').value||'0',10);
    const Style = document.getElementById('d_style').value;
    const Resultat = document.getElementById('d_resultat').value;
    const item = {Cotation, Relais, Style, Resultat};
    if(Resultat==='non_terminee'){
      item.Motif = document.getElementById('d_motif').value;
      item.Details = document.getElementById('d_details').value.trim() || null;
    }
    if(!Cotation){ alert('Saisir une cotation'); return; }
    list.push(item); render();
  };
  document.getElementById('btn-clear').onclick = ()=>{ list.length = 0; render(); };

  function itemToStr(it){
    let s = `${it.Cotation}|X${it.Relais}|${it.Style}`;
    if(it.Resultat==='reussie'){ s += '|OK'; }
    else { s += '|NT'; if(it.Motif){ s += ':'+it.Motif; } if(it.Details){ s += `(${it.Details})`; } }
    return s;
  }

  document.getElementById('btn-qr').onclick = ()=>{
    if(list.length===0){ alert('Ajoute au moins une réalisation'); return; }
    const payload = {};
    // identity first
    payload.Nom = id.Nom; payload.Prenom = id.Prenom; payload.Classe = id.Classe;
    payload.App = 'ClimbTrack'; payload.Type = 'difficulte';
    for(let i=0;i<list.length;i++){
      payload['Diff'+(i+1)] = itemToStr(list[i]); // one realization per column
    }
    payload.DateISO = nowISO();
    const {json} = makeQR(document.getElementById('qrd'), payload);
    document.getElementById('jsond').textContent = json;
    document.getElementById('qr-section').style.display = 'block';
    window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});
  };
</script>
</body>
</html>
