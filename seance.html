<!doctype html><html lang="fr"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ClimbTrack â€” QR de sÃ©ance</title><link rel="stylesheet" href="style.css"></head>
<body><div class="main-wrap"><div class="container">
  <div class="headerbar"><div class="logo">ğŸ“¦ <span class="highlight">QR de sÃ©ance</span></div>
    <div class="right"><a class="btn green big" href="menu.html">ğŸ  Menu</a><a class="btn blue big" href="aide.html">â“ Aide</a></div></div>
  <div class="card"><h2>RÃ©capitulatif</h2><p class="lead" id="idline"></p>

    <div class="row row-2">
      <div class="card"><h3>ğŸ§± Bloc</h3><div id="bzone" class="small">â€”</div></div>
      <div class="card"><h3>ğŸ§— DifficultÃ©</h3><div id="dzone" class="small">â€”</div></div>
    </div>
    <div class="row row-2" style="margin-top:12px;">
      <div class="card"><h3>âš¡ Vitesse</h3><div id="vzone" class="small">â€”</div></div>
      <div class="card"><h3>ğŸ“· CrÃ©ateur de voie</h3><div class="small">Prendre une photo â†’ <a class="btn edit" href="route-capture.html">Ouvrir</a> (non inclus dans le QR)</div></div>
    </div>

    <div class="center" style="margin-top:16px;">
      <button class="btn green big" id="btn_qr">ğŸ“· Un seul QR pour tout</button>
      <p class="note">Ordre des champs : <strong>nom, prenom, classe, bloc_*, difficulte_*, vitesse</strong></p>
      <div id="qr-section" style="display:none;margin-top:12px;">
        <div class="qr-wrap"><div class="qr-box" id="qrs"></div></div>
        <div class="actions" style="justify-content:center;gap:10px;margin-top:8px;">
          <span class="badge" id="bytes">0 octets (H)</span>
          <button class="btn blue" id="fullscreen">ğŸ–¥ï¸ Plein Ã©cran</button>
          <button class="btn" id="toggleLevel">Basculer Hâ†”Q</button>
        </div>
        <pre class="pre" id="jsons"></pre>
      </div>
    </div>
  </div></div>
  <footer><div class="container"><div class="footer-inner"></div></div></footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script type="module">
import {getIdentite, ensureIdentite, renderFooter, makeQR, loadSeance, setLastQRText} from './app.js';

renderFooter(); 
ensureIdentite(); 
const id=getIdentite(); 
document.getElementById('idline').innerHTML=`Ã‰lÃ¨ve : <strong>${id.prenom} ${id.nom}</strong> â€” <span class='badge'>Classe : ${id.classe}</span>`;

function styleCode(sty){ if(sty==='moulinette') return 'M'; if(sty==='en_tete') return 'T'; if(sty==='mouli_tete') return 'MT'; return ''; }
function motifCodeNE({degx, nbprise, td}){ 
  const parts=[]; 
  if(degx && degx>0) parts.push('NED'+degx); 
  if(nbprise && nbprise>0) parts.push('MC'+nbprise); 
  if(td) parts.push('TD'); 
  return parts.join(' '); 
}

function render(){ 
  const s=loadSeance();
  const vTxt=(s.vitesse&&s.vitesse.best)?`Best=${s.vitesse.best} â€¢ NbEssais=${s.vitesse.nb}`:'â€”'; 
  vzone.textContent=vTxt;

  dzone.textContent=(s.difficulte&&s.difficulte.length)
    ? s.difficulte.map((x,i)=>{
        let code = (x.res==='e1')?'E':(x.res==='e2'?'E2':'NE');
        if(x.res==='ne'){ 
          const more = motifCodeNE({degx:x.degx, nbprise:x.nbprise, td:x.td}); 
          if(more) code += ' '+more; 
        }
        return `D${i+1}:[${styleCode(x.style)}] R${x.relais} ${x.cotation} â€” ${code}`;
      }).join('  |  ')
    : 'â€”';

  bzone.textContent=(s.bloc&&s.bloc.length)
    ? s.bloc.map((x,i)=>`B${i+1}:${x.c} R${x.n}`).join('  |  ')
    : 'â€”';
}
render();

// --- RafraÃ®chissements â€œsilencieuxâ€ pour suivre les autosaves ---
// 1) Quand tu reviens sur lâ€™onglet
document.addEventListener('visibilitychange', ()=>{ 
  if (!document.hidden) render(); 
});
// 2) Quand un autre onglet modifie localStorage
window.addEventListener('storage', (e)=>{ 
  if (e.key && e.key.includes('seance')) render(); 
});
// 3) SÃ©curitÃ© : toutes les 5 secondes
setInterval(render, 5000);

document.getElementById('btn_qr').onclick=()=>{
  const s=loadSeance();
  const baseObj={ nom:id.nom, prenom:id.prenom, classe:id.classe };

  const buildObj=()=>{
    const obj={...baseObj};
    if(s.bloc && s.bloc.length){ 
      s.bloc.forEach((b,idx)=>{ obj['bloc_'+(idx+1)] = `${b.c} R${b.n}`; }); 
    }
    if(s.difficulte && s.difficulte.length){
      s.difficulte.forEach((d,idx)=>{
        const sc= (d.style==='moulinette')?'M':(d.style==='en_tete'?'T':'MT');
        let code=''; 
        if(d.res==='e1') code='E'; 
        else if(d.res==='e2') code='E2'; 
        else {
          const parts=[]; 
          if(d.degx && d.degx>0) parts.push('NED'+d.degx); 
          if(d.nbprise && d.nbprise>0) parts.push('MC'+d.nbprise); 
          if(d.td) parts.push('TD');
          code='NE' + (parts.length?(' '+parts.join(' ')):''); 
        }
        obj['difficulte_'+(idx+1)] = `${sc} R${d.relais} ${d.cotation} ${code}`;
      });
    }
    if(s.vitesse && s.vitesse.best){ obj.vitesse = s.vitesse.best; }
    return obj;
  };

  const enc = new TextEncoder();
  let level='H';

  function renderQR(levelNow){
    const qrObj = buildObj();
    const qrTxt = JSON.stringify([qrObj]);
    document.getElementById('qrs').innerHTML='';
    makeQR('qrs', qrObj, levelNow);
    jsons.textContent=qrTxt;
    setLastQRText(qrTxt);
    const bcount = enc.encode(qrTxt).length;
    const warn = document.getElementById('bytes');
    warn.textContent = bcount + ' octets (' + levelNow + ')';
    if(levelNow==='H' && bcount>1100) { warn.textContent += ' â€¢ proche de la limite, Q recommandÃ©'; }
  }

  renderQR(level);
  document.getElementById('qr-section').style.display='block';
  document.getElementById('fullscreen').onclick=()=>{ location.href='qrfull.html'; };
  document.getElementById('toggleLevel').onclick=()=>{ level = (level==='H'?'Q':'H'); renderQR(level); };
};
</script></body></html>
