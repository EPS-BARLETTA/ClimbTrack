<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ClimbTrack â€” Vitesse</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="main-wrap">
  <div class="container">
    <div class="headerbar">
      <div class="logo">âš¡ <span class="highlight">Vitesse</span></div>
      <div class="right">
        <a class="btn green big" href="menu.html">ğŸ  Menu</a>
        <a class="btn blue big" href="aide.html">â“ Aide</a>
      </div>
    </div>

    <div class="card">
      <h2>Essais & meilleur temps</h2>
      <p class="lead" id="idline"></p>

      <div class="row row-2">
        <div class="card">
          <h3>â±ï¸ Saisie manuelle</h3>
          <div class="row row-3">
            <label>Minutes<input id="vm" type="number" min="0" max="59" value="0"></label>
            <label>Secondes<input id="vs" type="number" min="0" max="59" value="0"></label>
            <label>CentiÃ¨mes<input id="vc" type="number" min="0" max="99" value="0"></label>
          </div>
          <div class="actions">
            <button class="btn blue big" id="btn_add">â• Ajouter essai</button>
            <button class="btn red big" id="btn_clear">â™»ï¸ Vider essais</button>
          </div>
        </div>

        <div class="card">
          <h3>â±ï¸ Chrono intÃ©grÃ© (option)</h3>
          <p class="small">Uniquement si votre mur nâ€™a pas de chrono.</p>
          <div style="font-size:2.2rem;font-weight:900;margin:10px 0;" id="vtimer">00:00:00</div>
          <div class="actions">
            <button class="btn green big" id="vstart">Lancer</button>
            <button class="btn amber big" id="vstop">Stop</button>
            <button class="btn red big" id="vreset">RÃ©init</button>
            <button class="btn blue big" id="btn_add_from_chrono">â• Ajouter depuis chrono</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Mes essais</h3>
        <table class="table" id="v_table">
          <thead>
            <tr><th>#</th><th>Temps</th><th>Action</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <p class="lead">Meilleur temps : <strong id="best"></strong> â€¢ Nb essais : <strong id="nb"></strong></p>
        <div class="actions">
          <button class="btn green big" id="btn_save">ğŸ’¾ Enregistrer sÃ©ance</button>
          <button class="btn green big" id="btn_qr">ğŸ“· QR code Vitesse</button>
          <a class="btn" href="seance.html">â¡ï¸ QR de sÃ©ance</a>
        </div>
        <div id="qr-section" style="display:none;margin-top:16px;">
          <h3>ğŸ“· QR code prÃªt</h3>
          <div class="qr-wrap"><div class="qr-box" id="qrv"></div><pre class="pre" id="jsonv"></pre></div>
        </div>
      </div>

    </div>
  </div>
</div>

<footer>
  <div class="container"><div class="footer-inner"></div></div>
</footer>

<div id="autosave-toast" style="
    position:fixed; left:50%; bottom:16px; transform:translate(-50%,12px);
    background:#16a34a; color:#fff; padding:10px 14px; border-radius:12px;
    font-weight:600; font-size:.95rem; box-shadow:0 6px 18px rgba(0,0,0,.2);
    opacity:0; transition:opacity .25s ease, transform .25s ease; z-index:9999;
">SÃ©ance enregistrÃ©e âœ…</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script type="module">
import {getIdentite, ensureIdentite, renderFooter, formatTime, parseTimeToCentis, loadSeance, saveSeance, makeQR} from './app.js';

renderFooter(); 
ensureIdentite();

const id=getIdentite(); 
document.getElementById('idline').innerHTML = `Ã‰lÃ¨ve : <strong>${id.prenom} ${id.nom}</strong> â€” <span class='badge'>Classe : ${id.classe}</span>`;

const runs=[], tbody=document.querySelector('#v_table tbody'), bestEl=document.getElementById('best'), nbEl=document.getElementById('nb');

// Toast helper
function showToast(msg='SÃ©ance enregistrÃ©e âœ…'){
  const t = document.getElementById('autosave-toast');
  t.textContent = msg;
  t.style.opacity = '1';
  t.style.transform = 'translate(-50%, 0)';
  clearTimeout(t._hide);
  t._hide = setTimeout(()=>{
    t.style.opacity = '0';
    t.style.transform = 'translate(-50%, 12px)';
  }, 1500);
}

function render(){ 
  tbody.innerHTML=''; 
  let best=null;
  runs.forEach((it,i)=>{ 
    const tr=document.createElement('tr'); 
    tr.innerHTML=`<td>${i+1}</td><td>${it}</td><td><button class="btn red" data-i="${i}">Supprimer</button></td>`; 
    tbody.appendChild(tr);
    const val=parseTimeToCentis(it); 
    if(best===null || val<best.val){ best={val, txt:it}; } 
  });
  tbody.querySelectorAll('button[data-i]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      runs.splice(+e.currentTarget.dataset.i,1); 
      render();
      debouncedAutoSave(); 
    });
  });
  bestEl.textContent=best?best.txt:'â€”'; 
  nbEl.textContent=runs.length;
}

function bestAndCount(){ 
  if(!runs.length) return {best:null,count:0}; 
  let best=runs[0], bv=parseTimeToCentis(best); 
  for(let i=1;i<runs.length;i++){ 
    const v=parseTimeToCentis(runs[i]); 
    if(v<bv){ best=runs[i]; bv=v; } 
  } 
  return {best, count:runs.length}; 
}

function persistVitesse(silent=true){
  const bc = bestAndCount();
  if (!bc.count) return;
  const s = loadSeance();
  s.vitesse = { essais: runs.slice(), best: bc.best, nb: bc.count };
  saveSeance(s);
  showToast();
  if (!silent) alert('Vitesse enregistrÃ©e âœ…');
}

function debounce(fn, delay){
  let t;
  return (...args)=>{
    clearTimeout(t);
    t = setTimeout(()=>fn(...args), delay);
  };
}
const debouncedAutoSave = debounce(()=>persistVitesse(true), 800);

// Actions
document.getElementById('btn_add').onclick=()=>{ 
  const Temps = formatTime(vm.value,vs.value,vc.value); 
  runs.push(Temps); 
  render(); 
  debouncedAutoSave(); 
};
document.getElementById('btn_clear').onclick=()=>{ 
  runs.length=0; 
  render(); 
};

let t0=0, timer=null, running=false;
function tick(){ 
  const dt=Date.now()-t0, c=Math.floor(dt/10)%100, s=Math.floor(dt/1000)%60, m=Math.floor(dt/60000); 
  vtimer.textContent=formatTime(m,s,c); 
}
document.getElementById('vstart').onclick=()=>{ if(!running){ running=true; t0=Date.now(); timer=setInterval(tick, 10);} };
document.getElementById('vstop').onclick=()=>{ if(!running) return; running=false; clearInterval(timer); timer=null; };
document.getElementById('vreset').onclick=()=>{ running=false; if(timer) clearInterval(timer); vtimer.textContent='00:00:00'; };
document.getElementById('btn_add_from_chrono').onclick=()=>{ runs.push(vtimer.textContent); render(); debouncedAutoSave(); };

document.getElementById('btn_save').onclick=()=>{ persistVitesse(false); };

document.getElementById('btn_qr').onclick=()=>{
  const bc=bestAndCount(); 
  if(!bc.best){ alert('Ajoute un essai'); return; }
  const obj={ nom:id.nom, prenom:id.prenom, classe:id.classe, vitesse:bc.best };
  const txt=makeQR('qrv', obj); 
  jsonv.textContent=txt; 
  document.getElementById('qr-section').style.display='block';
};

document.addEventListener('visibilitychange', ()=>{ if (document.hidden) persistVitesse(true); });
window.addEventListener('beforeunload', ()=>{ persistVitesse(true); });
setInterval(()=>persistVitesse(true), 30000);

render();
</script>
</body>
</html>
