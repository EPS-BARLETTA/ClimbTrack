<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>ClimbTrack â€” Bloc</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="main-wrap">
  <div class="container">
    <div class="headerbar">
      <div class="logo">ğŸ§± <span class="highlight">Bloc</span></div>
      <div class="right">
        <a class="btn green big" href="menu.html">ğŸ  Menu</a>
        <a class="btn blue big" href="aide.html">â“ Aide</a>
      </div>
    </div>

    <div class="card">
      <h2>Blocs rÃ©ussis</h2>
      <p class="lead" id="idline"></p>

      <label>Couleur
        <select id="b_couleur">
          <option value="jaune">ğŸŸ¨ Jaune â€” facile</option>
          <option value="vert">ğŸŸ© Vert â€” peu difficile</option>
          <option value="bleu">ğŸŸ¦ Bleu â€” assez difficile</option>
          <option value="rouge">ğŸŸ¥ Rouge â€” difficile</option>
          <option value="noir">â¬› Noir â€” trÃ¨s difficile</option>
          <option value="mauve">ğŸŸª Mauve â€” abominable</option>
        </select>
      </label>
      <label>NumÃ©ro<input id="b_num" type="number" min="1" max="200" placeholder="Ex. 5"></label>

      <div class="actions">
        <button class="btn blue big" id="b_add">â• Ajouter</button>
        <button class="btn red big" id="b_clear">â™»ï¸ Vider</button>
      </div>

      <table class="table" id="b_table">
        <thead>
          <tr><th>#</th><th>Couleur</th><th>Niveau</th><th>NumÃ©ro</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="actions">
        <button class="btn green big" id="b_save">ğŸ’¾ Enregistrer sÃ©ance</button>
        <button class="btn green big" id="b_qr">ğŸ“· QR code Bloc</button>
        <a class="btn" href="seance.html">â¡ï¸ QR de sÃ©ance</a>
      </div>

      <div id="qr-section" style="display:none;margin-top:16px;">
        <h3>ğŸ“· QR code prÃªt</h3>
        <div class="qr-wrap">
          <div class="qr-box" id="qrb"></div>
          <pre class="pre" id="jsonb"></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container"><div class="footer-inner"></div></div>
</footer>

<div id="autosave-toast" style="
  position:fixed; left:50%; bottom:16px; transform:translate(-50%,12px);
  background:#16a34a; color:#fff; padding:10px 14px; border-radius:12px;
  font-weight:600; font-size:.95rem; box-shadow:0 6px 18px rgba(0,0,0,.2);
  opacity:0; transition:opacity .25s ease, transform .25s ease; z-index:9999;
">SÃ©ance enregistrÃ©e âœ…</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- Mac / PC -->
<script type="module" src="app.js"></script>
<!-- iPad / Safari -->
<script nomodule src="app.nomodule.js"></script>

<script>
renderFooter();
const id = ensureIdentite();
document.getElementById('idline').innerHTML = `Ã‰lÃ¨ve : <strong>${id.prenom} ${id.nom}</strong> â€” <span class='badge'>Classe : ${id.classe}</span>`;

const levelMap = { jaune:'facile', vert:'peu_difficile', bleu:'assez_difficile', rouge:'difficile', noir:'tres_difficile', mauve:'abominable' };

const list = [];
const tbody = document.querySelector('#b_table tbody');

function showToast(msg='SÃ©ance enregistrÃ©e âœ…'){
  const t = document.getElementById('autosave-toast');
  t.textContent = msg;
  t.style.opacity = '1';
  t.style.transform = 'translate(-50%, 0)';
  clearTimeout(t._hide);
  t._hide = setTimeout(()=>{
    t.style.opacity = '0';
    t.style.transform = 'translate(-50%, 12px)';
  }, 1500);
}

function render(){
  tbody.innerHTML = '';
  list.forEach((it,i)=>{
    const icon = `<span class="color-dot dot-${it.c}"></span>`;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${icon}${it.c}</td><td>${levelMap[it.c]}</td><td>${it.n}</td><td><button class="btn red" data-i="${i}">Supprimer</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-i]').forEach(btn=>{
    btn.addEventListener('click', e=>{
      list.splice(+e.currentTarget.dataset.i,1);
      render();
      debouncedAutoSave();
    });
  });
}

function persistBloc(silent=true){
  if(!list.length) return;
  saveSeanceMerge({ bloc: list.slice() });
  if(!silent) alert('Blocs enregistrÃ©s âœ…');
  showToast();
}

function debounce(fn, delay){
  let t;
  return (...args)=>{
    clearTimeout(t);
    t=setTimeout(()=>fn(...args), delay);
  };
}
const debouncedAutoSave = debounce(()=>persistBloc(true), 800);

document.getElementById('b_add').onclick = ()=>{
  const c = b_couleur.value;
  const n = parseInt(b_num.value||'0',10);
  if(!n){ alert('NumÃ©ro ?'); return; }
  list.push({c,n,lvl:levelMap[c]});
  render();
  debouncedAutoSave();
};

document.getElementById('b_clear').onclick = ()=>{
  list.length = 0;
  render();
};

document.getElementById('b_save').onclick = ()=>{ persistBloc(false); };

document.getElementById('b_qr').onclick = ()=>{
  if(!list.length){ alert('Ajoute un bloc'); return; }
  const obj = { nom:id.nom, prenom:id.prenom, classe:id.classe };
  list.forEach((b,idx)=>{ obj['bloc_'+(idx+1)] = `${b.c} R${b.n}`; });
  const txt = makeQR('qrb', obj);
  jsonb.textContent = txt;
  document.getElementById('qr-section').style.display='block';
};

document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) persistBloc(true); });
window.addEventListener('beforeunload', ()=>{ persistBloc(true); });
setInterval(()=>persistBloc(true), 30000);

render();
</script>
</body>
</html>
